<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œìš¸ì‹œ ê³µê³µìì „ê±° ëŒ€ì—¬ì†Œ ìœ„ì¹˜ í‘œì‹œ</title>
    <style>
      .header {
        text-align: center;
      }
      #map {
        width: 100%;
        height: 700px;
        margin-top: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #ccc;
      }
      #loadMoreBtn {
        padding: 10px 15px;

        position: absolute;
        right: 0;
        bottom: -50px;
        transition: 0.2s;
        border-radius: 8px;
        background: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 4px 7px rgba(0, 0, 0, 0.2);
      }
      #loadMoreBtn:hover {
        background: #45a049;
        transform: translateY(-3px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
      }

      #loadMoreBtn:active {
        transform: translateY(0);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <h2 class="header">ì„œìš¸ì‹œ ê³µê³µìì „ê±° ëŒ€ì—¬ì†Œ ìœ„ì¹˜ í‘œì‹œ</h2>
    <div style="width: 100%; position: relative">
      <div id="map"></div>
      <!-- âœ… ì¶”ê°€: ë” ë³´ê¸° ë²„íŠ¼ -->
      <button id="loadMoreBtn">ë” ë³´ê¸° (ë‹¤ìŒ 1000ê°œ)</button>
    </div>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_KEY&libraries=services"
    ></script>
    <script>
      const APIKey = "YOUR_SEOUL_API_KEY"; // ë‹¹ì‹ ì˜ APIKey ì…ë ¥

      // âœ… ì¶”ê°€: í˜ì´ì§€ ë²ˆí˜¸ & í˜ì´ì§€ë‹¹ ê°œìˆ˜
      let page = 1; // í˜„ì¬ í˜ì´ì§€
      const limit = 1000; // í•œ ë²ˆì— ë¶ˆëŸ¬ì˜¬ ê°œìˆ˜(ì„œìš¸ì‹œ API ê¸°ë³¸ 1000)

      function clearAllMarkers() {
        markers.forEach((m) => m.setMap(null));
        markers = [];
      }

      function loadData(page) {
        const start = (page - 1) * limit + 1; // 1, 1001, 2001, ...
        const end = page * limit; // 1000, 2000, 3000, ...
        const url = `http://openapi.seoul.go.kr:8088/${APIKey}/json/bikeList/${start}/${end}/`;
        console.log("ìš”ì²­ URL:", url);

        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            console.log(data);

            if (!data.rentBikeStatus || data.rentBikeStatus.row.length === 0) {
              alert("ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");

              page = 1; // í˜ì´ì§€ ì´ˆê¸°í™”

              clearAllMarkers();

              loadData(page);
              return;
            }

            const rows = data.rentBikeStatus.row;
            console.log(rows);

            rows.forEach((item) => {
              const lat = parseFloat(item.stationLatitude);
              const lon = parseFloat(item.stationLongitude);
              const name = item.stationName;
              const cnt = parseInt(item.parkingBikeTotCnt);

              const locPosition = new kakao.maps.LatLng(lat, lon);
              const message = `
                <div style="
                    padding:15px 10px;
                    white-space:normal;
                    max-width:260px;
                    font-size:14px;
                    line-height:1.4;
                    white-space:nowrap;           /* ğŸ”¥ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
                    word-break:keep-all;          /* ğŸ”¥ ë‹¨ì–´ ë¶„ë¦¬ ê¸ˆì§€ */
                  ">
                    <b>${name}</b><br>
                    ëŒ€ì—¬ ê°€ëŠ¥ ìì „ê±°: ${cnt}ëŒ€
                  </div>
              `;

              let imageSrc;
              if (cnt === 0) {
                imageSrc =
                  "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png";
              } else if (cnt >= 5) {
                imageSrc =
                  "https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png";
              } else {
                imageSrc =
                  "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png";
              }

              const imageSize = new kakao.maps.Size(32, 32);
              const markerImage = new kakao.maps.MarkerImage(
                imageSrc,
                imageSize
              );

              displayMarker(locPosition, message, markerImage);
            });
          })
          .catch((err) => {
            console.log("fetch ì‹¤íŒ¨ ë˜ëŠ” íŒŒì‹± ì˜¤ë¥˜", err);
          });
      }

      let markers = []; // ì „ì—­ ë°°ì—´

      function clearAllMarkers() {
        markers.forEach((m) => m.setMap(null));
        markers = [];
      }

      let map;

      window.onload = function () {
        kakao.maps.load(function () {
          const mapContainer = document.getElementById("map");
          const mapOption = {
            center: new kakao.maps.LatLng(37.499982, 127.035424),
            level: 3,
          };
          map = new kakao.maps.Map(mapContainer, mapOption);

          if (navigator.geolocation) {
            // GeoLocationì„ ì´ìš©í•´ì„œ ì ‘ì† ìœ„ì¹˜ë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
            navigator.geolocation.getCurrentPosition(function (position) {
              const lat = position.coords.latitude; // ìœ„ë„
              const lon = position.coords.longitude; // ê²½ë„

              const locPosition = new kakao.maps.LatLng(lat, lon); // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ë¥¼ geolocationìœ¼ë¡œ ì–»ì–´ì˜¨ ì¢Œí‘œë¡œ ìƒì„±í•©ë‹ˆë‹¤
              const message =
                '<div style="padding:5px;">ì—¬ê¸°ì— ê³„ì‹ ê°€ìš”?!</div>'; // ì¸í¬ìœˆë„ìš°ì— í‘œì‹œë  ë‚´ìš©ì…ë‹ˆë‹¤

              // ë§ˆì»¤ì™€ ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
              displayMarker(locPosition, message, markerImage);
            });
          } else {
            // HTML5ì˜ GeoLocationì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì„ë•Œ ë§ˆì»¤ í‘œì‹œ ìœ„ì¹˜ì™€ ì¸í¬ìœˆë„ìš° ë‚´ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤

            var locPosition = new kakao.maps.LatLng(33.450701, 126.570667),
              message = "geolocationì„ ì‚¬ìš©í• ìˆ˜ ì—†ì–´ìš”..";

            displayMarker(locPosition, message);
          }
          loadData(page);
        });
      };

      // âœ… ì¶”ê°€: "ë” ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤ìŒ í˜ì´ì§€ ë°ì´í„° ë¡œë“œ
      document
        .getElementById("loadMoreBtn")
        .addEventListener("click", function () {
          page++; // ë‹¤ìŒ í˜ì´ì§€
          loadData(page);
        });

      function displayMarker(locPosition, message, markerImage) {
        // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        const marker = new kakao.maps.Marker({
          map: map,
          position: locPosition,
          image: markerImage,
        });

        markers.push(marker); // ë§ˆì»¤ ì €ì¥
        const iwContent = message, // ì¸í¬ìœˆë„ìš°ì— í‘œì‹œí•  ë‚´ìš©
          iwRemoveable = true;

        // ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        const infowindow = new kakao.maps.InfoWindow({
          content: iwContent,
          removable: iwRemoveable,
        });

        kakao.maps.event.addListener(marker, "click", function () {
          // ë§ˆì»¤ ìœ„ì— ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
          infowindow.open(map, marker);
        });

        // ì§€ë„ ì¤‘ì‹¬ì¢Œí‘œë¥¼ ì ‘ì†ìœ„ì¹˜ë¡œ ë³€ê²½í•©ë‹ˆë‹¤
        map.setCenter(locPosition);
      }
    </script>
  </body>
</html>
