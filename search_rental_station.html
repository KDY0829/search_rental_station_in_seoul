<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œìš¸ì‹œ ê³µê³µìì „ê±° ëŒ€ì—¬ì†Œ ìœ„ì¹˜ í‘œì‹œ</title>
    <style>
      #map {
        width: 100%;
        height: 400px;
        margin-top: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <h2>ì„œìš¸ì‹œ ê³µê³µìì „ê±° ëŒ€ì—¬ì†Œ ìœ„ì¹˜ í‘œì‹œ</h2>
    <div id="map"></div>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_KEY&libraries=services"
    ></script>
    <script>
      const APIKey = "YOUR_SEOUL_API_KEY"; // ë‹¹ì‹ ì˜ APIKey ì…ë ¥
      const url = `http://openapi.seoul.go.kr:8088/${APIKey}/json/bikeList/1/1000/`;

      function lodaData() {
        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            console.log(data);
            const rows = data.rentBikeStatus.row;
            console.log(rows);

            rows.forEach((item) => {
              const lat = parseFloat(item.stationLatitude);
              const lon = parseFloat(item.stationLongitude);
              const name = item.stationName;
              const cnt = parseInt(item.parkingBikeTotCnt);

              const locPosition = new kakao.maps.LatLng(lat, lon);
              const message = `
                <div style="
                    padding:15px 10px;
                    white-space:normal;
                    max-width:260px;
                    font-size:14px;
                    line-height:1.4;
                    white-space:nowrap;           /* ğŸ”¥ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
                    word-break:keep-all;          /* ğŸ”¥ ë‹¨ì–´ ë¶„ë¦¬ ê¸ˆì§€ */
                  ">
                    <b>${name}</b><br>
                    ëŒ€ì—¬ ê°€ëŠ¥ ìì „ê±°: ${cnt}ëŒ€
                  </div>
              `;

              let imageSrc;
              if (cnt === 0) {
                imageSrc =
                  "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png";
              } else if (cnt >= 5) {
                imageSrc =
                  "https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png";
              } else {
                imageSrc =
                  "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png";
              }

              const imageSize = new kakao.maps.Size(32, 32);
              const markerImage = new kakao.maps.MarkerImage(
                imageSrc,
                imageSize
              );

              displayMarker(locPosition, message, markerImage);
            });
          })
          .catch((err) => {
            console.log("fetch ì‹¤íŒ¨ ë˜ëŠ” íŒŒì‹± ì˜¤ë¥˜", err);
          });
      }

      let map;

      window.onload = function () {
        kakao.maps.load(function () {
          const mapContainer = document.getElementById("map");
          const mapOption = {
            center: new kakao.maps.LatLng(37.499982, 127.035424),
            level: 3,
          };
          map = new kakao.maps.Map(mapContainer, mapOption);

          if (navigator.geolocation) {
            // GeoLocationì„ ì´ìš©í•´ì„œ ì ‘ì† ìœ„ì¹˜ë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
            navigator.geolocation.getCurrentPosition(function (position) {
              const lat = position.coords.latitude; // ìœ„ë„
              const lon = position.coords.longitude; // ê²½ë„

              const locPosition = new kakao.maps.LatLng(lat, lon); // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ë¥¼ geolocationìœ¼ë¡œ ì–»ì–´ì˜¨ ì¢Œí‘œë¡œ ìƒì„±í•©ë‹ˆë‹¤
              const message =
                '<div style="padding:5px;">ì—¬ê¸°ì— ê³„ì‹ ê°€ìš”?!</div>'; // ì¸í¬ìœˆë„ìš°ì— í‘œì‹œë  ë‚´ìš©ì…ë‹ˆë‹¤

              // ë§ˆì»¤ì™€ ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
              displayMarker(locPosition, message, markerImage);
            });
          } else {
            // HTML5ì˜ GeoLocationì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì„ë•Œ ë§ˆì»¤ í‘œì‹œ ìœ„ì¹˜ì™€ ì¸í¬ìœˆë„ìš° ë‚´ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤

            var locPosition = new kakao.maps.LatLng(33.450701, 126.570667),
              message = "geolocationì„ ì‚¬ìš©í• ìˆ˜ ì—†ì–´ìš”..";

            displayMarker(locPosition, message);
          }
          lodaData();
        });
      };

      function displayMarker(locPosition, message, markerImage) {
        // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        const marker = new kakao.maps.Marker({
          map: map,
          position: locPosition,
          image: markerImage,
        });

        const iwContent = message, // ì¸í¬ìœˆë„ìš°ì— í‘œì‹œí•  ë‚´ìš©
          iwRemoveable = true;

        // ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        const infowindow = new kakao.maps.InfoWindow({
          content: iwContent,
          removable: iwRemoveable,
        });

        kakao.maps.event.addListener(marker, "click", function () {
          // ë§ˆì»¤ ìœ„ì— ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
          infowindow.open(map, marker);
        });

        // ì§€ë„ ì¤‘ì‹¬ì¢Œí‘œë¥¼ ì ‘ì†ìœ„ì¹˜ë¡œ ë³€ê²½í•©ë‹ˆë‹¤
        map.setCenter(locPosition);
      }
    </script>
  </body>
</html>
